<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Vozes Comuns</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  deleteDoc,
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ========= FIREBASE ========= */
const firebaseConfig = {
  apiKey: "AIzaSyBc1CnD5D2YJvooqtUzOZKxElj-efqc-eM",
  authDomain: "vozes-comuns.firebaseapp.com",
  projectId: "vozes-comuns",
  storageBucket: "vozes-comuns.appspot.com",
  messagingSenderId: "6633055138",
  appId: "1:6633055138:web:8172f4a6eff3da159888fb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ========= ESTADO ========= */
let currentUser = null;
let currentBookId = null;
let currentBookOwner = null;
let allBooks = []; // üî• usado pela busca

/* ========= AUTH ========= */
window.register = async () =>
  createUserWithEmailAndPassword(auth, email.value, password.value);

window.login = async () =>
  signInWithEmailAndPassword(auth, email.value, password.value);

window.logout = async () => signOut(auth);

onAuthStateChanged(auth, user => {
  currentUser = user;
  authStatus.innerText = user ? `Logado: ${user.email}` : "Visitante";
  loadBooks();
});

/* ========= UI ========= */
window.show = id => {
  document.querySelectorAll("section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
  if(id==="books") loadBooks();
  if(id==="chapters") loadChapters();
};

/* ========= BOOKS ========= */
window.createBook = async () => {
  if(!currentUser) return alert("Fa√ßa login para criar livro");

  await addDoc(collection(db,"books"),{
    title: bookTitle.value,
    author: bookAuthor.value || "An√¥nimo",
    uid: currentUser.uid
  });

  bookTitle.value="";
  bookAuthor.value="";
  show("books");
};

async function loadBooks(){
  bookList.innerHTML="Carregando...";
  allBooks = [];

  const snap = await getDocs(collection(db,"books"));
  snap.forEach(d=>{
    allBooks.push({ id:d.id, ...d.data() });
  });

  renderBooks(allBooks);
}

function renderBooks(list){
  bookList.innerHTML="";
  if(list.length === 0){
    bookList.innerHTML="<p>Nenhum livro encontrado.</p>";
    return;
  }

  list.forEach(b=>{
    bookList.innerHTML+=`
      <div class="card">
        <b>${b.title}</b><br>
        <i>${b.author}</i><br><br>
        <button onclick="openBook('${b.id}')">Abrir</button>
        ${
          currentUser && b.uid===currentUser.uid
          ? `<button onclick="deleteBook('${b.id}')">Excluir</button>`
          : ""
        }
      </div>`;
  });
}

/* üîç BUSCA */
window.searchBooks = txt => {
  const t = txt.toLowerCase();
  const filtered = allBooks.filter(b =>
    b.title.toLowerCase().includes(t) ||
    b.author.toLowerCase().includes(t)
  );
  renderBooks(filtered);
};

window.openBook = async id => {
  currentBookId=id;
  const snap=await getDoc(doc(db,"books",id));
  const b=snap.data();
  bookName.innerText=b.title;
  currentBookOwner=b.uid;
  show("chapters");
};

window.deleteBook = async id => {
  if(!confirm("Excluir livro?")) return;
  const chapters=await getDocs(collection(db,"books",id,"chapters"));
  for(const c of chapters.docs) await deleteDoc(c.ref);
  await deleteDoc(doc(db,"books",id));
  loadBooks();
};

/* ========= CHAPTERS ========= */
async function loadChapters(){
  chapterList.innerHTML="";
  newChapterBtn.style.display =
    currentUser && currentUser.uid===currentBookOwner
    ? "inline-block"
    : "none";

  const snap=await getDocs(collection(db,"books",currentBookId,"chapters"));
  snap.forEach(d=>{
    const c=d.data();
    chapterList.innerHTML+=`
      <div class="card">
        <b>${c.title}</b><br><br>
        <button onclick="read('${c.title}','${encodeURIComponent(c.text)}')">Ler</button>
        ${
          currentUser && currentUser.uid===currentBookOwner
          ? `<button onclick="delChapter('${d.id}')">Excluir</button>`
          : ""
        }
      </div>`;
  });
}

window.saveChapter = async () => {
  if(!currentUser || currentUser.uid!==currentBookOwner)
    return alert("Voc√™ n√£o √© o autor");

  await addDoc(collection(db,"books",currentBookId,"chapters"),{
    title:chapterTitle.value,
    text:chapterText.value
  });

  chapterTitle.value="";
  chapterText.value="";
  show("chapters");
};

window.delChapter = async id => {
  if(confirm("Excluir cap√≠tulo")){
    await deleteDoc(doc(db,"books",currentBookId,"chapters",id));
    loadChapters();
  }
};

window.read = (t,txt)=>{
  rTitle.innerText=t;
  rText.innerText=decodeURIComponent(txt);
  show("read");
};

window.onload=()=>show("home");
</script>

<style>
body{font-family:Arial;background:#f4f4f4;margin:0}
header{background:#234;color:#fff;padding:15px;text-align:center}
nav button{margin:5px}
section{display:none;padding:20px}
.card{background:#fff;padding:10px;margin:10px 0}
textarea{width:100%;height:260px}
pre{white-space:pre-wrap}
input[type=text]{padding:6px;width:100%;max-width:400px}
</style>
</head>

<body>

<header>
<h1>Vozes Comuns</h1>
<nav>
<button onclick="show('home')">In√≠cio</button>
<button onclick="show('books')">Livros</button>
<button onclick="show('newBook')">Novo Livro</button>
<button onclick="show('auth')">Login</button>
</nav>
<p id="authStatus"></p>
</header>

<section id="home">
<h2>Bem-vindo</h2>
<p>Leia hist√≥rias reais escritas por pessoas reais.</p>
</section>

<section id="auth">
<input id="email" placeholder="Email"><br><br>
<input id="password" type="password" placeholder="Senha"><br><br>
<button onclick="login()">Entrar</button>
<button onclick="register()">Registrar</button>
<button onclick="logout()">Sair</button>
</section>

<section id="books">
<h2>Livros</h2>
<input type="text" placeholder="Buscar por t√≠tulo ou autor..." oninput="searchBooks(this.value)">
<div id="bookList"></div>
</section>

<section id="newBook">
<input id="bookAuthor" placeholder="Autor"><br><br>
<input id="bookTitle" placeholder="T√≠tulo"><br><br>
<button onclick="createBook()">Criar</button>
</section>

<section id="chapters">
<h2 id="bookName"></h2>
<button id="newChapterBtn" onclick="show('newChapter')">Novo Cap√≠tulo</button>
<div id="chapterList"></div>
<button onclick="show('books')">Voltar</button>
</section>

<section id="newChapter">
<input id="chapterTitle" placeholder="T√≠tulo"><br><br>
<textarea id="chapterText"></textarea><br>
<button onclick="saveChapter()">Salvar</button>
</section>

<section id="read">
<h2 id="rTitle"></h2>
<pre id="rText"></pre>
<button onclick="show('chapters')">Voltar</button>
</section>

</body>
</html>
