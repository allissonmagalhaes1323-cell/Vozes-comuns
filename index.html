<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Vozes Comuns</title>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getAuth, onAuthStateChanged, 
  signInWithEmailAndPassword, 
  createUserWithEmailAndPassword, 
  signOut, updateProfile 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import { 
  getFirestore, collection, addDoc, getDocs, 
  doc, deleteDoc, updateDoc, increment 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBc1CnD5D2YJvooqtUzOZKxElj-efqc-eM",
  authDomain: "vozes-comuns.firebaseapp.com",
  projectId: "vozes-comuns",
  storageBucket: "vozes-comuns.appspot.com",
  messagingSenderId: "6633055138",
  appId: "1:6633055138:web:8172f4a6eff3da159888fb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

window.auth = auth;
window.db = db;
</script>

<style>
body{font-family:Arial;margin:0;background:#f4f4f4}
header{background:#234;color:#fff;padding:15px;text-align:center}
nav button{margin:5px;padding:8px 15px}
section{display:none;padding:20px}
.card{background:#fff;padding:10px;margin:10px 0}
textarea{width:100%;height:260px}
input,select{padding:6px;width:100%;max-width:400px}
button{cursor:pointer;margin:3px}
pre{white-space:pre-wrap}
small{color:#555}
</style>
</head>

<body>

<header>
<h1>Vozes Comuns</h1>
<nav>
<span id="userInfo"></span><br>
<button onclick="show('books')">Livros</button>
<button onclick="show('newBook')">Novo Livro</button>
<button onclick="logout()">Sair</button>
</nav>
</header>

<section id="login">
<h2>Login</h2>
<input id="email" placeholder="Email"><br><br>
<input id="password" type="password" placeholder="Senha"><br><br>
<input id="name" placeholder="Nome (para cadastro)"><br><br>
<button onclick="login()">Entrar</button>
<button onclick="register()">Cadastrar</button>
</section>

<section id="books">
<h2>Livros</h2>

<input id="search" placeholder="Buscar por t√≠tulo..." oninput="loadBooks()"><br><br>

<select id="genreFilter" onchange="loadBooks()">
<option value="">Todos os g√™neros</option>
<option>Drama</option>
<option>Romance</option>
<option>Fantasia</option>
<option>Terror</option>
<option>Suspense</option>
<option>A√ß√£o</option>
<option>Realismo</option>
<option>Biografia</option>
<option>Fic√ß√£o Cient√≠fica</option>
</select>

<div id="bookList"></div>
</section>

<section id="newBook">
<h2>Novo Livro</h2>
<input id="bookTitle" placeholder="T√≠tulo"><br><br>

<label>G√™neros:</label><br>
<select id="bookGenres" multiple size="5">
<option>Drama</option>
<option>Romance</option>
<option>Fantasia</option>
<option>Terror</option>
<option>Suspense</option>
<option>A√ß√£o</option>
<option>Realismo</option>
<option>Biografia</option>
<option>Fic√ß√£o Cient√≠fica</option>
</select><br><br>

<button onclick="createBook()">Criar Livro</button>
</section>

<section id="chapters">
<h2 id="bookName"></h2>
<div id="chapterActions"></div>
<div id="chapterList"></div>
<button onclick="show('books')">Voltar</button>
</section>

<section id="newChapter">
<h2>Novo Cap√≠tulo</h2>
<input id="chapterTitle" placeholder="T√≠tulo"><br><br>
<textarea id="chapterText"></textarea><br>
<button onclick="saveChapter()">Salvar</button>
<button onclick="show('chapters')">Cancelar</button>
</section>

<section id="read">
<h2 id="rTitle"></h2>
<pre id="rText"></pre>
<button onclick="show('chapters')">Voltar</button>
</section>

<script type="module">
import { collection, getDocs, addDoc, deleteDoc, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

let currentUser = null;
let currentBook = null;

function show(id){
  document.querySelectorAll("section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
}
window.show = show;

window.login = async ()=>{
  await signInWithEmailAndPassword(auth,email.value,password.value);
};

window.register = async ()=>{
  const cred = await createUserWithEmailAndPassword(auth,email.value,password.value);
  await updateProfile(cred.user,{displayName:name.value});
};

window.logout = ()=>signOut(auth);

onAuthStateChanged(auth, async u=>{
  currentUser=u;
  if(u){
    userInfo.innerText=`${u.displayName} (${u.email})`;
    await loadBooks();
    show("books");
  }else show("login");
});

window.createBook = async ()=>{
  const genres=[...bookGenres.selectedOptions].map(o=>o.value);
  await addDoc(collection(db,"books"),{
    title:bookTitle.value,
    genres,
    authorId:currentUser.uid,
    authorName:currentUser.displayName,
    authorEmail:currentUser.email,
    views:0
  });
  bookTitle.value="";
  loadBooks();
  show("books");
};

window.loadBooks = async ()=>{
  bookList.innerHTML="";
  const snap = await getDocs(collection(db,"books"));
  snap.forEach(d=>{
    const b=d.data();
    if(search.value && !b.title.toLowerCase().includes(search.value.toLowerCase())) return;
    if(genreFilter.value && !b.genres.includes(genreFilter.value)) return;

    bookList.innerHTML+=`
    <div class="card">
    <b>${b.title}</b><br>
    <small>${b.authorName} (${b.authorEmail})</small><br>
    <small>${b.genres.join(", ")}</small><br>
    <small>üëÅ ${b.views||0}</small><br><br>
    <button onclick="openBook('${d.id}','${b.title}',${b.authorId==='${currentUser.uid}'} )">Abrir</button>
    </div>`;
  });
};

window.openBook = async (id,title)=>{
  currentBook=id;
  bookName.innerText=title;
  await updateDoc(doc(db,"books",id),{views:increment(1)});
  loadChapters();
  show("chapters");
};

window.loadChapters = async ()=>{
  chapterList.innerHTML="";
  chapterActions.innerHTML="";
  const snap=await getDocs(collection(db,"books",currentBook,"chapters"));
  snap.forEach(d=>{
    const c=d.data();
    chapterList.innerHTML+=`
    <div class="card">
    <b>${c.title}</b><br><br>
    <button onclick="read('${c.title}','${encodeURIComponent(c.text)}')">Ler</button>
    ${c.authorId===currentUser.uid?`<button onclick="delChapter('${d.id}')">Excluir</button>`:""}
    </div>`;
  });
};

window.saveChapter = async ()=>{
  await addDoc(collection(db,"books",currentBook,"chapters"),{
    title:chapterTitle.value,
    text:chapterText.value,
    authorId:currentUser.uid
  });
  show("chapters");
};

window.read=(t,txt)=>{
  rTitle.innerText=t;
  rText.innerText=decodeURIComponent(txt);
  show("read");
};

window.delChapter=async(id)=>{
  if(confirm("Excluir?")){
    await deleteDoc(doc(db,"books",currentBook,"chapters",id));
    loadChapters();
  }
};
</script>

</body>
</html>
