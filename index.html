<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Vozes Comuns</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs,
  deleteDoc, doc, updateDoc, increment
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {
  getAuth, onAuthStateChanged,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signOut, updateProfile
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBc1CnD5D2YJvooqtUzOZKxElj-efqc-eM",
  authDomain: "vozes-comuns.firebaseapp.com",
  projectId: "vozes-comuns",
  storageBucket: "vozes-comuns.appspot.com",
  messagingSenderId: "6633055138",
  appId: "1:6633055138:web:8172f4a6eff3da159888fb"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;
let currentBookId = null;

window.show = id => {
  document.querySelectorAll("section").forEach(s => s.style.display = "none");
  document.getElementById(id).style.display = "block";
};

onAuthStateChanged(auth, u => {
  currentUser = u;
  if (u) {
    userInfo.innerText = `${u.displayName} (${u.email})`;
    loadBooks();
    show("books");
  } else {
    show("login");
  }
});

window.login = async () => {
  await signInWithEmailAndPassword(auth, email.value, password.value);
};

window.register = async () => {
  const cred = await createUserWithEmailAndPassword(auth, email.value, password.value);
  await updateProfile(cred.user, { displayName: name.value });
};

window.logout = () => signOut(auth);

// -------- LIVROS --------

window.createBook = async () => {
  const genres = [...document.querySelectorAll("input[name=genre]:checked")].map(g=>g.value);

  await addDoc(collection(db,"books"),{
    title: bookTitle.value,
    authorName: currentUser.displayName,
    authorEmail: currentUser.email,
    authorId: currentUser.uid,
    genres,
    views: 0,
    created: Date.now()
  });

  bookTitle.value="";
  loadBooks();
  show("books");
};

async function loadBooks(){
  bookList.innerHTML="";
  const snap = await getDocs(collection(db,"books"));

  snap.forEach(d=>{
    const b=d.data();
    bookList.innerHTML+=`
    <div class="card">
      <b>${b.title}</b><br>
      <i>${b.authorName} (${b.authorEmail})</i><br>
      G√™neros: ${b.genres.join(", ")}<br>
      üëÅ ${b.views}<br><br>
      <button onclick="openBook('${d.id}','${b.title}')">Abrir</button>
      ${currentUser.uid===b.authorId
        ? `<button onclick="deleteBook('${d.id}')">Excluir</button>`
        : ""}
    </div>`;
  });
}
window.loadBooks=loadBooks;

window.deleteBook = async id=>{
  if(confirm("Excluir livro?")){
    await deleteDoc(doc(db,"books",id));
    loadBooks();
  }
};

// -------- CAP√çTULOS --------

window.openBook = async (id,title)=>{
  currentBookId=id;
  bookName.innerText=title;

  await updateDoc(doc(db,"books",id),{views:increment(1)});
  loadChapters();
  show("chapters");
};

async function loadChapters(){
  chapterList.innerHTML="";
  const snap = await getDocs(collection(db,"books",currentBookId,"chapters"));

  snap.forEach(d=>{
    const c=d.data();
    chapterList.innerHTML+=`
    <div class="card">
      <b>${c.title}</b><br><br>
      <button onclick="read('${c.title}','${encodeURIComponent(c.text)}')">Ler</button>
      ${currentUser.uid===c.authorId
        ? `<button onclick="delChapter('${d.id}')">Excluir</button>`
        : ""}
    </div>`;
  });
}
window.loadChapters=loadChapters;

window.saveChapter = async ()=>{
  await addDoc(collection(db,"books",currentBookId,"chapters"),{
    title: chapterTitle.value,
    text: chapterText.value,
    authorId: currentUser.uid
  });
  chapterTitle.value=chapterText.value="";
  loadChapters();
  show("chapters");
};

window.delChapter = async id=>{
  if(confirm("Excluir cap√≠tulo?")){
    await deleteDoc(doc(db,"books",currentBookId,"chapters",id));
    loadChapters();
  }
};

window.read=(t,txt)=>{
  rTitle.innerText=t;
  rText.innerText=decodeURIComponent(txt);
  show("read");
};
</script>

<style>
body{font-family:Arial;background:#f4f4f4;margin:0}
header{background:#234;color:#fff;padding:10px;text-align:center}
nav button{margin:5px}
section{display:none;padding:20px}
.card{background:#fff;padding:10px;margin:10px 0}
</style>
</head>

<body>

<header>
<h1>Vozes Comuns</h1>
<nav>
<button onclick="show('books')">Livros</button>
<button onclick="show('newBook')">Novo Livro</button>
<button onclick="logout()">Sair</button>
<span id="userInfo"></span>
</nav>
</header>

<section id="login">
<h2>Login / Cadastro</h2>
<input id="name" placeholder="Nome (cadastro)"><br>
<input id="email" placeholder="Email"><br>
<input id="password" type="password" placeholder="Senha"><br><br>
<button onclick="login()">Entrar</button>
<button onclick="register()">Cadastrar</button>
</section>

<section id="books">
<h2>Livros</h2>
<div id="bookList"></div>
</section>

<section id="newBook">
<h2>Novo Livro</h2>
<input id="bookTitle" placeholder="T√≠tulo"><br><br>

<b>G√™neros:</b><br>
<label><input type="checkbox" name="genre" value="Romance"> Romance</label>
<label><input type="checkbox" name="genre" value="Drama"> Drama</label>
<label><input type="checkbox" name="genre" value="Fantasia"> Fantasia</label>
<label><input type="checkbox" name="genre" value="Terror"> Terror</label>
<label><input type="checkbox" name="genre" value="Fic√ß√£o"> Fic√ß√£o</label>
<label><input type="checkbox" name="genre" value="Biografia"> Biografia</label><br><br>

<button onclick="createBook()">Criar</button>
</section>

<section id="chapters">
<h2 id="bookName"></h2>
<button onclick="show('newChapter')">Novo Cap√≠tulo</button>
<div id="chapterList"></div>
<button onclick="show('books')">Voltar</button>
</section>

<section id="newChapter">
<input id="chapterTitle" placeholder="T√≠tulo"><br><br>
<textarea id="chapterText"></textarea><br>
<button onclick="saveChapter()">Salvar</button>
</section>

<section id="read">
<h2 id="rTitle"></h2>
<pre id="rText"></pre>
<button onclick="show('chapters')">Voltar</button>
</section>

</body>
</html>
