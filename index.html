<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Vozes Comuns</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, doc,
  deleteDoc, updateDoc, increment, getDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {
  getAuth, createUserWithEmailAndPassword,
  signInWithEmailAndPassword, signOut,
  onAuthStateChanged, updateProfile
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBc1CnD5D2YJvooqtUzOZKxElj-efqc-eM",
  authDomain: "vozes-comuns.firebaseapp.com",
  projectId: "vozes-comuns",
  storageBucket: "vozes-comuns.appspot.com",
  messagingSenderId: "6633055138",
  appId: "1:6633055138:web:8172f4a6eff3da159888fb"
};

const app = initializeApp(firebaseConfig);
window.db = getFirestore(app);
window.auth = getAuth(app);
</script>

<style>
body{font-family:Arial;margin:0;background:#f4f4f4}
header{background:#234;color:#fff;padding:15px;text-align:center}
nav button{margin:5px;padding:8px 15px}
section{display:none;padding:20px}
.card{background:#fff;padding:10px;margin:10px 0}
textarea{width:100%;height:220px}
input,select{margin:5px 0;padding:6px;width:100%}
.search{max-width:400px;margin:10px auto}
</style>
</head>

<body>

<header>
<h1>Vozes Comuns</h1>
<p id="userInfo"></p>
<nav>
<button onclick="show('home')">In√≠cio</button>
<button onclick="show('books')">Livros</button>
<button onclick="show('newBook')">Novo Livro</button>
<button onclick="logout()">Sair</button>
</nav>
</header>

<section id="login">
<h2>Login / Cadastro</h2>
<input id="name" placeholder="Nome (cadastro)">
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Senha">
<button onclick="login()">Entrar</button>
<button onclick="register()">Cadastrar</button>
</section>

<section id="home">
<h2>Bem-vindo</h2>
<p>Leia hist√≥rias ou publique a sua.</p>
</section>

<section id="books">
<h2>Livros</h2>

<div class="search">
<input id="search" placeholder="Buscar por t√≠tulo, autor ou email" oninput="loadBooks()">
</div>

<div id="bookList"></div>
</section>

<section id="newBook">
<h2>Novo Livro</h2>
<input id="bookTitle" placeholder="T√≠tulo">
<select id="bookGenre">
<option>Romance</option><option>Terror</option><option>Fantasia</option>
<option>Fic√ß√£o Cient√≠fica</option><option>Drama</option><option>Suspense</option>
<option>Aventura</option><option>Biografia</option><option>Poesia</option>
<option>Hist√≥rico</option><option>Outros</option>
</select>
<button onclick="createBook()">Criar Livro</button>
</section>

<section id="chapters">
<h2 id="bookName"></h2>
<button id="btnNewChapter" onclick="show('newChapter')">Novo Cap√≠tulo</button>
<div id="chapterList"></div>
<button onclick="show('books')">Voltar</button>
</section>

<section id="newChapter">
<h2>Novo Cap√≠tulo</h2>
<input id="chapterTitle" placeholder="T√≠tulo">
<textarea id="chapterText"></textarea>
<button onclick="saveChapter()">Salvar</button>
<button onclick="show('chapters')">Cancelar</button>
</section>

<section id="read">
<h2 id="rTitle"></h2>
<pre id="rText"></pre>
<button onclick="show('chapters')">Voltar</button>
</section>

<script type="module">
import {
  collection, addDoc, getDocs, deleteDoc, doc,
  updateDoc, increment, getDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {
  onAuthStateChanged,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signOut,
  updateProfile
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

let currentUser=null, currentBookId=null, currentBookAuthor=null;

window.show=id=>{
document.querySelectorAll("section").forEach(s=>s.style.display="none");
document.getElementById(id).style.display="block";
};

onAuthStateChanged(auth,u=>{
currentUser=u;
if(u){
userInfo.innerText=`${u.displayName} (${u.email})`;
show("home");
}else show("login");
});

window.login=()=>signInWithEmailAndPassword(auth,email.value,password.value);
window.register=async()=>{
const c=await createUserWithEmailAndPassword(auth,email.value,password.value);
await updateProfile(c.user,{displayName:name.value});
};
window.logout=()=>signOut(auth);

window.createBook=async()=>{
await addDoc(collection(db,"books"),{
title:bookTitle.value,
genre:bookGenre.value,
authorId:currentUser.uid,
authorName:currentUser.displayName,
authorEmail:currentUser.email,
views:0
});
bookTitle.value="";
loadBooks(); show("books");
};

window.loadBooks=async()=>{
bookList.innerHTML="";
const q=search.value.toLowerCase();
const snap=await getDocs(collection(db,"books"));
snap.forEach(d=>{
const b=d.data();
if(
!b.title.toLowerCase().includes(q)&&
!b.authorName.toLowerCase().includes(q)&&
!b.authorEmail.toLowerCase().includes(q)
) return;

const isAuthor=currentUser&&currentUser.uid===b.authorId;
bookList.innerHTML+=`
<div class="card">
<b>${b.title}</b> (${b.genre})<br>
<i>${b.authorName}</i><br>
<small>${b.authorEmail}</small><br>
üëÅÔ∏è ${b.views}<br>
<button onclick="openBook('${d.id}')">Abrir</button>
${isAuthor?`<button onclick="deleteBook('${d.id}')">Excluir</button>`:""}
</div>`;
});
};

window.openBook=async id=>{
currentBookId=id;
const ref=doc(db,"books",id);
const b=(await getDoc(ref)).data();
currentBookAuthor=b.authorId;
bookName.innerText=b.title;
btnNewChapter.style.display=currentUser&&currentUser.uid===b.authorId?"block":"none";
await updateDoc(ref,{views:increment(1)});
loadChapters(); show("chapters");
};

window.loadChapters=async()=>{
chapterList.innerHTML="";
const snap=await getDocs(collection(db,"books",currentBookId,"chapters"));
snap.forEach(d=>{
const c=d.data();
const isAuthor=currentUser&&currentUser.uid===currentBookAuthor;
chapterList.innerHTML+=`
<div class="card">
<b>${c.title}</b><br>
<button onclick="read('${c.title}',\`${c.text}\`)">Ler</button>
${isAuthor?`<button onclick="delChapter('${d.id}')">Excluir</button>`:""}
</div>`;
});
};

window.read=(t,txt)=>{rTitle.innerText=t;rText.innerText=txt;show("read");};

window.saveChapter=async()=>{
if(currentUser.uid!==currentBookAuthor)return alert("Sem permiss√£o");
await addDoc(collection(db,"books",currentBookId,"chapters"),{
title:chapterTitle.value,text:chapterText.value
});
chapterTitle.value=chapterText.value="";
loadChapters(); show("chapters");
};

window.delChapter=async id=>{
if(confirm("Excluir cap√≠tulo?")){
await deleteDoc(doc(db,"books",currentBookId,"chapters",id));
loadChapters();
}
};

window.deleteBook=async id=>{
if(confirm("Excluir livro?")){
await deleteDoc(doc(db,"books",id));
loadBooks();
}
};

show("login");
</script>

</body>
</html>
