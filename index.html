<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Vozes Comuns</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, doc,
  deleteDoc, updateDoc, increment
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {
  getAuth, createUserWithEmailAndPassword,
  signInWithEmailAndPassword, signOut,
  onAuthStateChanged, updateProfile
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBc1CnD5D2YJvooqtUzOZKxElj-efqc-eM",
  authDomain: "vozes-comuns.firebaseapp.com",
  projectId: "vozes-comuns",
  storageBucket: "vozes-comuns.appspot.com",
  messagingSenderId: "6633055138",
  appId: "1:6633055138:web:8172f4a6eff3da159888fb"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

window.db = db;
window.auth = auth;
</script>

<style>
body{font-family:Arial;margin:0;background:#f4f4f4}
header{background:#234;color:#fff;padding:15px;text-align:center}
nav button{margin:5px;padding:8px 15px}
section{display:none;padding:20px}
.card{background:#fff;padding:10px;margin:10px 0}
textarea{width:100%;height:220px}
.genres label{display:inline-block;margin-right:10px}
</style>
</head>

<body>

<header>
<h1>Vozes Comuns</h1>
<p id="userInfo"></p>
<nav>
<button onclick="show('home')">In√≠cio</button>
<button onclick="show('books')">Livros</button>
<button onclick="show('newBook')">Novo Livro</button>
<button onclick="logout()">Sair</button>
</nav>
</header>

<section id="login">
<h2>Entrar / Criar Conta</h2>
<input id="name" placeholder="Seu nome"><br><br>
<input id="email" placeholder="Email"><br><br>
<input id="password" type="password" placeholder="Senha"><br><br>
<button onclick="login()">Entrar</button>
<button onclick="register()">Criar Conta</button>
</section>

<section id="home">
<h2>Bem-vindo</h2>
<p>Hist√≥rias reais escritas por pessoas reais.</p>
</section>

<section id="books">
<h2>Livros</h2>
<div id="bookList"></div>
</section>

<section id="newBook">
<h2>Novo Livro</h2>
<input id="bookTitle" placeholder="T√≠tulo do livro"><br><br>

<h3>G√™neros</h3>
<div id="genreList"></div><br>

<button onclick="createBook()">Criar Livro</button>
</section>

<section id="chapters">
<h2 id="bookName"></h2>
<button onclick="show('newChapter')">Novo Cap√≠tulo</button>
<div id="chapterList"></div>
<button onclick="show('books')">Voltar</button>
</section>

<section id="newChapter">
<h2>Novo Cap√≠tulo</h2>
<input id="chapterTitle" placeholder="T√≠tulo"><br><br>
<textarea id="chapterText" placeholder="Texto"></textarea><br>
<button onclick="saveChapter()">Salvar</button>
<button onclick="show('chapters')">Cancelar</button>
</section>

<script type="module">
import {
  collection, addDoc, getDocs, doc,
  updateDoc, increment
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {
  onAuthStateChanged,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signOut,
  updateProfile
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

let currentUser = null;
let currentBookId = null;

const GENRES = [
  "A√ß√£o","Aventura","Biografia","Cr√¥nica","Drama",
  "Fantasia","Fic√ß√£o Cient√≠fica","Filosofia","Hist√≥ria",
  "Horror / Terror","Investiga√ß√£o / Mist√©rio","LGBT+",
  "Poesia","Pol√≠tica","Romance","Relatos Reais",
  "Religi√£o / Espiritualidade","Supera√ß√£o","Suspense",
  "Vida Cotidiana"
];

function show(id){
  document.querySelectorAll("section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
  if(id==="books") loadBooks();
}
window.show = show;

onAuthStateChanged(auth,user=>{
  if(user){
    currentUser = user;
    userInfo.innerText = `Logado como: ${user.displayName} (${user.email})`;
    renderGenres();
    show("home");
  }else{
    show("login");
  }
});

function renderGenres(){
  genreList.innerHTML="";
  GENRES.forEach(g=>{
    genreList.innerHTML+=`
      <label><input type="checkbox" value="${g}"> ${g}</label>
    `;
  });
}

window.login = async function(){
  await signInWithEmailAndPassword(auth,email.value,password.value);
}

window.register = async function(){
  const cred = await createUserWithEmailAndPassword(auth,email.value,password.value);
  await updateProfile(cred.user,{displayName:name.value});
}

window.logout = async function(){
  await signOut(auth);
}

async function createBook(){
  if(!currentUser) return alert("Fa√ßa login");

  const tags = [...document.querySelectorAll("#genreList input:checked")]
    .map(c=>c.value);

  await addDoc(collection(db,"books"),{
    title: bookTitle.value,
    authorName: currentUser.displayName,
    authorEmail: currentUser.email,
    authorId: currentUser.uid,
    tags,
    views: 0,
    createdAt: Date.now()
  });

  bookTitle.value="";
  renderGenres();
  show("books");
}
window.createBook = createBook;

async function loadBooks(){
  bookList.innerHTML="";
  const snap = await getDocs(collection(db,"books"));
  snap.forEach(d=>{
    const b=d.data();
    bookList.innerHTML+=`
      <div class="card">
        <b>${b.title}</b><br>
        <i>${b.authorName}</i><br>
        <small>${b.authorEmail}</small><br>
        üè∑Ô∏è ${(b.tags||[]).join(", ")}<br>
        üëÅÔ∏è ${b.views||0}
        <br><button onclick="openBook('${d.id}','${b.title}')">Abrir</button>
      </div>
    `;
  });
}

window.openBook = async function(id,title){
  currentBookId=id;
  bookName.innerText=title;
  await updateDoc(doc(db,"books",id),{views:increment(1)});
  show("chapters");
}
</script>

</body>
</html>
